<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Speech Translator</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0; padding: 20px;
        background: #f4f9ff;
    }
    .controls { margin-bottom: 20px; }
    select, button {
        padding: 10px 15px;
        margin: 5px;
        font-size: 16px;
        border-radius: 8px;
    }
    .entry {
        background: white;
        padding: 15px;
        margin-top: 12px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
</style>
</head>

<body>

<h2>Speech Translator</h2>

<div class="controls">
    <select id="inputLang">
        <option value="en-US">English</option>
        <option value="es-ES">Spanish</option>
        <option value="fr-FR">French</option>
    </select>

    <select id="outputLang">
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="en">English</option>
    </select>

    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="clearBtn">Clear All</button>
</div>

<div id="status">Press Start to begin</div>
<div id="results"></div>

<script>
let recognizing = false;
let finalTranscript = "";
let recognition;

function setupRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();

    recognition.lang = document.getElementById("inputLang").value;
    recognition.continuous = true;         // REQUIRED for Android
    recognition.interimResults = false;    // Prevents Android fragment spam

    recognition.onstart = () => {
        recognizing = true;
        finalTranscript = "";
        document.getElementById("status").innerText = "Listening...";
    };

    recognition.onerror = (event) => {
        console.log("Speech error:", event);
    };

    recognition.onresult = async (event) => {
        let transcript = "";

        // Android sends multiple "final" chunks → recombine manually
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                transcript += event.results[i][0].transcript;
            }
        }

        transcript = transcript.replace(/(\r\n|\n|&#10;)/g, " ").trim();

        if (!transcript) return;

        finalTranscript += " " + transcript;
        finalTranscript = finalTranscript.trim();

        const translated = await translateText(finalTranscript);
        addEntry(finalTranscript, translated);

        finalTranscript = ""; // Reset so Android doesn't duplicate
    };

    recognition.onend = () => {
        if (recognizing) recognition.start(); // Android auto-restart fix
    };
}

document.getElementById("startBtn").onclick = () => {
    if (!recognition) setupRecognition();
    recognizing = true;
    recognition.start();
};

document.getElementById("stopBtn").onclick = () => {
    recognizing = false;
    if (recognition) recognition.stop();
    document.getElementById("status").innerText = "Stopped.";
};

document.getElementById("clearBtn").onclick = () => {
    document.getElementById("results").innerHTML = "";
};

async function translateText(text) {
    const outLang = document.getElementById("outputLang").value;
    try {
        const res = await fetch(
            "https://api.mymemory.translated.net/get?q=" +
            encodeURIComponent(text) +
            "&langpair=en|" + outLang
        );
        const data = await res.json();
        return data.responseData.translatedText;
    } catch {
        return "(translation failed)";
    }
}

function addEntry(original, translated) {
    const container = document.createElement("div");
    container.className = "entry";
    container.innerHTML = `<b>${original}</b><br>→ ${translated}`;
    document.getElementById("results").prepend(container);
}
</script>

</body>
</html>
