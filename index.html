class TranslationService {
    constructor() {
        this.services = {
            libretranslate: {
                url: 'https://libretranslate.com/translate',
                params: (text) => ({
                    q: text,
                    source: 'es',
                    target: 'en',
                    format: 'text',
                    api_key: ''
                }),
                parse: (data) => data.translatedText || "Translation failed"
            }
        };
        this.currentService = 'libretranslate';
    }

    async translate(text) {
        try {
            const service = this.services[this.currentService];
            const response = await fetch(service.url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json'
                },
                body: new URLSearchParams(service.params(text))
            });

            if (!response.ok) {
                throw new Error(`Translation service unavailable: ${response.statusText}`);
            }

            const data = await response.json();
            return service.parse(data);
        } catch (error) {
            console.error('Translation error:', error);
            throw error;
        }
    }
}

// Enhanced speech recognition initialization
function initializeSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert("Speech recognition is not supported in your browser. Please use Chrome.");
        return null;
    }

    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.lang = "es-ES";
    recognition.maxResults = 10;

    recognition.onstart = () => {
        console.log('Speech recognition started');
        statusEl.textContent = "Status: Listening...";
    };

    recognition.onerror = (error) => {
        console.error('Speech recognition error:', error);
        statusEl.textContent = `Recognition error: ${error.error || 'Unknown error'}`;
    };

    recognition.onend = () => {
        console.log('Speech recognition ended');
        if (recording) {
            recognition.start();
        }
    };

    return recognition;
}

// Enhanced translation function with detailed error handling
async function translateText(text) {
    try {
        console.log('Attempting translation:', text);
        const translatedText = await translationService.translate(text);
        console.log('Translation successful:', translatedText);
        return translatedText;
    } catch (error) {
        console.error('Translation failed:', error);
        statusEl.textContent = "Status: Translation failed";
        return "Translation service unavailable";
    }
}

// Enhanced event handler with error recovery
recognition.onresult = async (event) => {
    for (let i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
            const phrase = event.results[i][0].transcript.trim();
            if (!phrase) continue;

            recognizedEl.textContent = phrase;
            statusEl.textContent = "Status: Translating...";
            
            try {
                const translatedText = await translateText(phrase);
                translatedEl.textContent = translatedText;

                const queueItem = document.createElement("div");
                queueItem.classList.add("queue-item");
                queueItem.textContent = `${phrase} â†’ ${translatedText}`;
                queueEl.appendChild(queueItem);
                queueEl.scrollTop = queueEl.scrollHeight;

                ttsQueue.push(translatedText);
                processTTSQueue();
            } catch (error) {
                translatedEl.textContent = "Translation failed";
                statusEl.textContent = "Status: Error occurred";
            }

            statusEl.textContent = "Status: Listening...";
        }
    }
};
