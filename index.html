<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real-Time Translator</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
  button { padding: 12px 20px; margin: 10px; font-size: 16px; border-radius: 10px; border: none; background: #007BFF; color: white; cursor: pointer; }
  button:disabled { background: gray; cursor: not-allowed; }
  select { padding: 8px; font-size: 16px; margin: 5px; }
  #translations, #liveText { margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; background: #f8f8f8; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  #translations { max-height: 250px; overflow-y: auto; }
  .chunk { padding: 5px 35px 5px 5px; margin-bottom: 5px; border-radius: 5px; background-color: #e0f7fa; position: relative; }
  .replayBtn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #007BFF; color: white; border: none; border-radius: 5px; padding: 2px 5px; cursor: pointer; font-size: 12px; }
  #liveText { font-style: italic; color: #333; }
</style>
</head>
<body>

<h1>Real-Time Translator ğŸŒ</h1>
<p>Select languages and press Start:</p>

<button id="enableAudioBtn">ğŸ”Š Enable Audio</button>

<label for="fromLang">ğŸ¤ Input Language:</label>
<select id="fromLang">
  <option value="en">English</option>
  <option value="es">Spanish</option>
  <option value="fr">French</option>
  <option value="de">German</option>
  <option value="sv">Swedish</option>
</select>

<label for="toLang">ğŸ”Š Output Language:</label>
<select id="toLang">
  <option value="en">English</option>
  <option value="es">Spanish</option>
  <option value="fr">French</option>
  <option value="de">German</option>
  <option value="sv">Swedish</option>
</select>

<br><br>
<button id="toggleBtn">â–¶ Start</button>
<button id="replayAllBtn">ğŸ” Replay All</button>
<button id="clearBtn">ğŸ§¹ Clear All</button>

<div id="liveText">ğŸ™ï¸ Live text will appear here...</div>
<div id="translations"></div>

<script>
const enableAudioBtn = document.getElementById("enableAudioBtn");
const toggleBtn = document.getElementById("toggleBtn");
const replayAllBtn = document.getElementById("replayAllBtn");
const clearBtn = document.getElementById("clearBtn");
const translationsDiv = document.getElementById("translations");
const liveText = document.getElementById("liveText");
const fromLang = document.getElementById("fromLang");
const toLang = document.getElementById("toLang");

const langMap = { 
  "es": "es-ES", 
  "en": "en-US", 
  "sv": "sv-SE", 
  "fr": "fr-FR",
  "de": "de-DE"
};

let recognition;
let listening = false;
let allTranslations = [];
let audioEnabled = false;

enableAudioBtn.addEventListener("click", () => {
  // Unlock speech synthesis on mobile (required for Samsung)
  speechSynthesis.cancel(); // Clear any pending speech
  const utterance = new SpeechSynthesisUtterance("Audio Enabled");
  utterance.volume = 0.1; // Very quiet test
  speechSynthesis.speak(utterance);
  
  audioEnabled = true;
  enableAudioBtn.disabled = true;
  enableAudioBtn.textContent = "âœ… Audio Enabled";
  
  // Load voices (Samsung specific)
  if (speechSynthesis.getVoices().length === 0) {
    speechSynthesis.addEventListener('voiceschanged', () => {
      console.log("Voices loaded:", speechSynthesis.getVoices().length);
    });
  }
});

// Samsung compatibility: check for both webkit and standard API
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (SpeechRecognition) {
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  recognition.onresult = (event) => {
    // Clear any existing silence timer
    if (silenceTimer) {
      clearTimeout(silenceTimer);
      silenceTimer = null;
    }

    let interimTranscript = "";
    let finalTranscript = "";

    // Collect all final and interim results
    for (let i = 0; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      
      if (event.results[i].isFinal) {
        finalTranscript += transcript + " ";
      } else {
        interimTranscript += transcript;
      }
    }

    // If we have new final results, process them immediately
    if (finalTranscript) {
      const textToTranslate = finalTranscript.trim();
      liveText.textContent = "ğŸ™ï¸ Translating...";
      
      const from = fromLang.value;
      const to = toLang.value;

      fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=${from}|${to}`)
        .then(res => res.json())
        .then(data => {
          const translated = data?.responseData?.translatedText || "(translation failed)";
          addTranslation(textToTranslate, translated);
          if(audioEnabled) speak(translated, langMap[to]);
          liveText.textContent = "ğŸ™ï¸ Listening...";
        })
        .catch(() => {
          addTranslation(textToTranslate, "(translation failed)");
          liveText.textContent = "ğŸ™ï¸ Listening...";
        });
    } else if (interimTranscript) {
      // Just show interim results, don't translate yet
      liveText.textContent = "ğŸ™ï¸ " + interimTranscript.trim();
    }
  };

  recognition.onerror = (e) => { 
    console.warn("Recognition error:", e.error);
    // Samsung sometimes stops on 'no-speech' error, restart if needed
    if (e.error === 'no-speech' && listening) {
      setTimeout(() => {
        if (listening) {
          try {
            recognition.start();
          } catch (err) {
            console.warn("Could not restart after no-speech:", err);
          }
        }
      }, 100);
    } else if (e.error === 'aborted' && listening) {
      // Handle aborted errors by restarting
      setTimeout(() => {
        if (listening) {
          try {
            recognition.start();
          } catch (err) {
            console.warn("Could not restart after abort:", err);
          }
        }
      }, 100);
    }
  };

  // Samsung may stop unexpectedly, add handler to restart
  recognition.onend = () => {
    if (listening) {
      setTimeout(() => {
        if (listening) {
          try {
            recognition.start();
          } catch (e) {
            console.warn("Could not restart recognition:", e);
          }
        }
      }, 100);
    }
  };
} else {
  alert("Speech Recognition not supported in this browser.");
}

function addTranslation(original, translated) {
  const chunkDiv = document.createElement("div");
  chunkDiv.className = "chunk";
  chunkDiv.innerHTML = `<strong>${original}</strong> â†’ ${translated}`;
  const replayBtn = document.createElement("button");
  replayBtn.textContent = "ğŸ”Š";
  replayBtn.className = "replayBtn";
  replayBtn.onclick = () => speak(translated, langMap[toLang.value]);
  chunkDiv.appendChild(replayBtn);

  translationsDiv.appendChild(chunkDiv);
  translationsDiv.scrollTop = translationsDiv.scrollHeight;

  allTranslations.push(translated);
}

function speak(text, langCode) {
  // Cancel any ongoing speech
  speechSynthesis.cancel();
  
  // Small delay helps with Samsung devices
  setTimeout(() => {
    const utterance = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    const match = voices.find(v => v.lang.startsWith(langCode));
    if (match) utterance.voice = match;
    utterance.lang = langCode;
    utterance.rate = 0.9; // Slightly slower for better clarity on Samsung
    utterance.pitch = 1.0;
    speechSynthesis.speak(utterance);
  }, 100);
}

// Toggle start/stop
toggleBtn.addEventListener("click", () => {
  if (!listening) {
    try {
      recognition.lang = langMap[fromLang.value];
      recognition.start();
      listening = true;
      toggleBtn.textContent = "â¹ Stop";
      liveText.textContent = "ğŸ™ï¸ Listening...";
    } catch (e) {
      console.warn("Could not start recognition:", e);
      alert("Could not start speech recognition. Please try again.");
    }
  } else {
    try {
      recognition.stop();
    } catch (e) {
      console.warn("Error stopping recognition:", e);
    }
    listening = false;
    toggleBtn.textContent = "â–¶ Start";
    liveText.textContent = "ğŸ™ï¸ Live text will appear here...";
  }
});

// Replay all translations on user gesture
replayAllBtn.addEventListener("click", () => {
  if (allTranslations.length === 0) {
    alert("No translations to replay yet!");
    return;
  }
  allTranslations.forEach((text, i) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = langMap[toLang.value];
    setTimeout(() => speechSynthesis.speak(utterance), i * 1500);
  });
});

// Clear all with confirmation
clearBtn.addEventListener("click", () => {
  const confirmClear = confirm("Are you sure you want to clear all translations?");
  if (!confirmClear) return;
  translationsDiv.innerHTML = "";
  liveText.textContent = "ğŸ™ï¸ Live text will appear here...";
  allTranslations = [];
  speechSynthesis.cancel();
});

window.speechSynthesis.onvoiceschanged = () => {};
</script>
</body>
</html>
