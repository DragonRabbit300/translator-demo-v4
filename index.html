<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real-Time Translator</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
  button { padding: 12px 20px; margin: 10px; font-size: 16px; border-radius: 10px; border: none; background: #007BFF; color: white; cursor: pointer; }
  button:disabled { background: gray; cursor: not-allowed; }
  select { padding: 8px; font-size: 16px; margin: 5px; }
  #translations, #liveText { margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; background: #f8f8f8; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  #translations { max-height: 250px; overflow-y: auto; }
  .chunk { padding: 5px 35px 5px 5px; margin-bottom: 5px; border-radius: 5px; background-color: #e0f7fa; position: relative; }
  .replayBtn { position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: #007BFF; color: white; border: none; border-radius: 5px; padding: 2px 5px; cursor: pointer; font-size: 12px; }
  #liveText { font-style: italic; color: #333; }
  .detected-lang { font-size: 12px; color: #666; margin-left: 5px; }
  #setupModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
  #setupContent { background: white; padding: 30px; border-radius: 15px; max-width: 400px; }
  #setupContent h2 { margin-top: 0; }
  #setupContent button { width: 100%; margin-top: 15px; }
</style>
</head>
<body>

<div id="setupModal">
  <div id="setupContent">
    <h2>ğŸŒ Translator Setup</h2>
    <p>Select your default output language:</p>
    <label for="setupToLang">ğŸ”Š I want translations in:</label>
    <select id="setupToLang">
      <option value="en">English</option>
      <option value="es">Spanish</option>
      <option value="fr">French</option>
      <option value="de">German</option>
      <option value="sv">Swedish</option>
      <option value="it">Italian</option>
      <option value="pt">Portuguese</option>
      <option value="ru">Russian</option>
      <option value="ja">Japanese</option>
      <option value="zh">Chinese</option>
    </select>
    <button id="startSetupBtn">âœ… Start Translator</button>
  </div>
</div>

<h1>Real-Time Translator ğŸŒ</h1>
<p>Auto-detect input language | Output: <strong id="outputLangDisplay">English</strong></p>

<button id="enableAudioBtn">ğŸ”Š Enable Audio & Start</button>

<br><br>
<button id="toggleBtn" disabled>â–¶ Start</button>
<button id="replayAllBtn">ğŸ” Replay All</button>
<button id="clearBtn">ğŸ§¹ Clear All</button>
<button id="changeLangBtn">ğŸ”§ Change Output Language</button>

<div id="liveText">ğŸ™ï¸ Live text will appear here...</div>
<div id="translations"></div>

<script>
const setupModal = document.getElementById("setupModal");
const setupToLang = document.getElementById("setupToLang");
const startSetupBtn = document.getElementById("startSetupBtn");
const enableAudioBtn = document.getElementById("enableAudioBtn");
const toggleBtn = document.getElementById("toggleBtn");
const replayAllBtn = document.getElementById("replayAllBtn");
const clearBtn = document.getElementById("clearBtn");
const changeLangBtn = document.getElementById("changeLangBtn");
const translationsDiv = document.getElementById("translations");
const liveText = document.getElementById("liveText");
const outputLangDisplay = document.getElementById("outputLangDisplay");

const langMap = { 
  "es": "es-ES", 
  "en": "en-US", 
  "sv": "sv-SE", 
  "fr": "fr-FR",
  "de": "de-DE",
  "it": "it-IT",
  "pt": "pt-PT",
  "ru": "ru-RU",
  "ja": "ja-JP",
  "zh": "zh-CN"
};

const langNames = {
  "en": "English",
  "es": "Spanish",
  "fr": "French",
  "de": "German",
  "sv": "Swedish",
  "it": "Italian",
  "pt": "Portuguese",
  "ru": "Russian",
  "ja": "Japanese",
  "zh": "Chinese"
};

let recognition;
let currentTranscript = "";
let listening = false;
let allTranslations = [];
let audioEnabled = false;
let silenceTimer = null;
let outputLang = "en";

// Show setup modal on load
setupModal.style.display = "flex";

startSetupBtn.addEventListener("click", () => {
  outputLang = setupToLang.value;
  outputLangDisplay.textContent = langNames[outputLang];
  setupModal.style.display = "none";
  toggleBtn.disabled = false;
});

changeLangBtn.addEventListener("click", () => {
  setupToLang.value = outputLang;
  setupModal.style.display = "flex";
});

// Handle headphone button press (media keys)
if ('mediaSession' in navigator) {
  navigator.mediaSession.setActionHandler('play', () => {
    if (!audioEnabled) {
      enableAudio();
    }
    if (!listening) {
      startRecording();
    }
  });
  
  navigator.mediaSession.setActionHandler('pause', () => {
    if (listening) {
      stopRecording();
    }
  });
}

// Also listen for spacebar as alternative
document.addEventListener('keydown', (e) => {
  if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
    e.preventDefault();
    if (!audioEnabled) {
      enableAudio();
    } else if (!listening) {
      startRecording();
    } else {
      stopRecording();
    }
  }
});

function enableAudio() {
  const utterance = new SpeechSynthesisUtterance("Audio Enabled");
  speechSynthesis.speak(utterance);
  audioEnabled = true;
  enableAudioBtn.disabled = true;
  enableAudioBtn.textContent = "âœ… Audio Enabled";
  toggleBtn.disabled = false;
}

enableAudioBtn.addEventListener("click", () => {
  enableAudio();
  startRecording();
});

function startRecording() {
  if (!recognition) return;
  recognition.start();
  listening = true;
  toggleBtn.textContent = "â¹ Stop";
  liveText.textContent = "ğŸ™ï¸ Listening...";
}

function stopRecording() {
  if (!recognition) return;
  recognition.stop();
  listening = false;
  toggleBtn.textContent = "â–¶ Start";
  if (silenceTimer) clearTimeout(silenceTimer);
  commitChunk();
}

if ("webkitSpeechRecognition" in window) {
  recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = ""; // Auto-detect

  recognition.onresult = (event) => {
    if (silenceTimer) {
      clearTimeout(silenceTimer);
      silenceTimer = null;
    }

    const lastIndex = event.results.length - 1;
    const result = event.results[lastIndex];
    const transcript = (result[0].transcript || "").trim();
    
    if (!transcript) return;
    
    if (result.isFinal) {
      currentTranscript += transcript + " ";
      liveText.textContent = "ğŸ™ï¸ " + currentTranscript.trim();
      
      silenceTimer = setTimeout(() => {
        commitChunk();
      }, 700);
    } else {
      liveText.textContent = "ğŸ™ï¸ " + (currentTranscript + transcript).trim();
      
      silenceTimer = setTimeout(() => {
        if (transcript && !currentTranscript.includes(transcript)) {
          currentTranscript += transcript + " ";
          commitChunk();
        }
      }, 1200);
    }
  };

  recognition.onerror = (e) => { 
    console.warn("Recognition error:", e);
    if (e.error === 'no-speech') {
      liveText.textContent = "ğŸ™ï¸ No speech detected...";
    }
  };

  recognition.onend = () => {
    if (listening) {
      recognition.start();
    }
  };
} else {
  alert("Speech Recognition not supported in this browser.");
}

async function detectLanguage(text) {
  try {
    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=auto|${outputLang}`);
    const data = await response.json();
    return data?.responseData?.detectedLanguage || "unknown";
  } catch (err) {
    return "unknown";
  }
}

async function commitChunk() {
  const transcript = currentTranscript.trim();
  if (!transcript) return;

  const textToTranslate = transcript;
  currentTranscript = "";
  silenceTimer = null;
  liveText.textContent = "ğŸ™ï¸ Translating...";

  try {
    const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(textToTranslate)}&langpair=auto|${outputLang}`);
    const data = await response.json();
    const translated = data?.responseData?.translatedText || "(translation failed)";
    const detectedLang = data?.responseData?.detectedLanguage || "auto";
    
    addTranslation(textToTranslate, translated, detectedLang);
    if (audioEnabled) speak(translated, langMap[outputLang]);
  } catch (err) {
    addTranslation(textToTranslate, "(translation failed)", "error");
  }
  
  liveText.textContent = "ğŸ™ï¸ Listening...";
}

function addTranslation(original, translated, detectedLang) {
  const chunkDiv = document.createElement("div");
  chunkDiv.className = "chunk";
  const langDisplay = detectedLang !== "error" && detectedLang !== "auto" ? 
    `<span class="detected-lang">[${detectedLang}]</span>` : "";
  chunkDiv.innerHTML = `<strong>${original}</strong>${langDisplay} â†’ ${translated}`;
  const replayBtn = document.createElement("button");
  replayBtn.textContent = "ğŸ”Š";
  replayBtn.className = "replayBtn";
  replayBtn.onclick = () => speak(translated, langMap[outputLang]);
  chunkDiv.appendChild(replayBtn);

  translationsDiv.appendChild(chunkDiv);
  translationsDiv.scrollTop = translationsDiv.scrollHeight;

  allTranslations.push(translated);
}

function speak(text, langCode) {
  const utterance = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices();
  const match = voices.find(v => v.lang.startsWith(langCode));
  if (match) utterance.voice = match;
  utterance.lang = langCode;
  speechSynthesis.speak(utterance);
}

toggleBtn.addEventListener("click", () => {
  if (!listening) {
    startRecording();
  } else {
    stopRecording();
  }
});

replayAllBtn.addEventListener("click", () => {
  if (allTranslations.length === 0) {
    alert("No translations to replay yet!");
    return;
  }
  allTranslations.forEach((text, i) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = langMap[outputLang];
    setTimeout(() => speechSynthesis.speak(utterance), i * 1500);
  });
});

clearBtn.addEventListener("click", () => {
  const confirmClear = confirm("Are you sure you want to clear all translations?");
  if (!confirmClear) return;
  translationsDiv.innerHTML = "";
  liveText.textContent = "ğŸ™ï¸ Listening...";
  allTranslations = [];
  speechSynthesis.cancel();
});

window.speechSynthesis.onvoiceschanged = () => {};
</script>
</body>
</html>
